@page "{id:int}"
@model MESSystem.Pages.Cards.DetailModel
@{
    ViewData["Title"] = $"카드 상세 - {Model.Card?.CardNumber}";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    @if (Model.Card == null)
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            카드를 찾을 수 없습니다.
        </div>
        <a href="/Cards" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> 목록으로
        </a>
    }
    else
    {
        <!-- 카드 헤더 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-0">
                            <i class="fas fa-id-card me-2"></i>
                            카드번호: <strong>@Model.Card.CardNumber</strong>
                        </h4>
                    </div>
                    <div class="col-auto">
                        @if (Model.Card.Status == "대기")
                        {
                            <span class="badge bg-warning text-dark fs-5">대기</span>
                        }
                        else if (Model.Card.Status == "작업중")
                        {
                            <span class="badge bg-info fs-5">작업중</span>
                        }
                        else if (Model.Card.Status == "완료")
                        {
                            <span class="badge bg-success fs-5">완료</span>
                        }
                        else if (Model.Card.Status == "보류")
                        {
                            <span class="badge bg-secondary fs-5">보류</span>
                        }
                        else
                        {
                            <span class="badge bg-light text-dark fs-5">@Model.Card.Status</span>
                        }

                        @if (Model.Card.IsModified)
                        {
                            <span class="badge bg-warning text-dark fs-6 ms-2">수정됨</span>
                        }
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-info-circle me-2 text-primary"></i>기본 정보</h5>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th style="width: 150px">분류:</th>
                                <td><strong>@Model.Card.Category.Name</strong></td>
                            </tr>
                            <tr>
                                <th>주문번호:</th>
                                <td>
                                    <a href="/Admin/Orders/Detail/@Model.Card.OrderId" class="text-decoration-none">
                                        @Model.Card.Order.OrderNumber
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>거래처:</th>
                                <td>@Model.Card.Order.ClientName</td>
                            </tr>
                            <tr>
                                <th>출고방법:</th>
                                <td>@Model.Card.Order.ShippingMethod</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-calendar-alt me-2 text-success"></i>일정 정보</h5>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th style="width: 150px">출고일시:</th>
                                <td>
                                    <strong>@Model.Card.Order.ShippingDate.ToString("yyyy-MM-dd")</strong>
                                    @if (Model.Card.Order.ShippingTime.HasValue)
                                    {
                                        <span class="text-muted">
                                            (@Model.Card.Order.ShippingTime.Value.ToString(@"hh\:mm"))
                                        </span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <th>카드 생성일:</th>
                                <td>@Model.Card.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                            </tr>
                            @if (Model.Card.UpdatedAt.HasValue)
                            {
                                <tr>
                                    <th>최종 수정일:</th>
                                    <td>@Model.Card.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm")</td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>

                <!-- 상태 변경 버튼 -->
                <div class="mt-3">
                    <form method="post" class="d-inline">
                        <input type="hidden" name="cardId" value="@Model.Card.Id" />
                        
                        @if (Model.Card.Status == "대기")
                        {
                            <button type="submit" asp-page-handler="StartWork" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i> 작업 시작
                            </button>
                        }
                        else if (Model.Card.Status == "작업중")
                        {
                            <button type="submit" asp-page-handler="CompleteWork" class="btn btn-success btn-lg me-2">
                                <i class="fas fa-check me-2"></i> 작업 완료
                            </button>
                            <button type="submit" asp-page-handler="PauseWork" class="btn btn-warning btn-lg">
                                <i class="fas fa-pause me-2"></i> 보류
                            </button>
                        }
                        else if (Model.Card.Status == "보류")
                        {
                            <button type="submit" asp-page-handler="ResumeWork" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i> 재개
                            </button>
                        }
                        else if (Model.Card.Status == "완료")
                        {
                            <button type="submit" asp-page-handler="ResetWork" class="btn btn-secondary btn-lg">
                                <i class="fas fa-redo me-2"></i> 대기로 변경
                            </button>
                        }
                    </form>

                    <a href="/Cards/Print/@Model.Card.Id" target="_blank" class="btn btn-outline-secondary btn-lg ms-3">
                        <i class="fas fa-print me-2"></i> 인쇄
                    </a>

                    <a href="/Cards" class="btn btn-outline-primary btn-lg ms-2">
                        <i class="fas fa-list me-2"></i> 목록
                    </a>
                </div>
            </div>
        </div>

        <!-- 품목 라인 정보 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-box me-2 text-warning"></i>
                    품목 정보 (@(Model.Card.CardItems.Count)개)
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%">#</th>
                                <th style="width: 15%">품목코드</th>
                                <th style="width: 20%">품목명</th>
                                <th style="width: 10%">수량</th>
                                <th style="width: 15%">규격</th>
                                <th style="width: 20%">디자인 파일</th>
                                <th style="width: 15%">비고</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Card.CardItems.OrderBy(ci => ci.OrderItem.LineNumber))
                            {
                                <tr>
                                    <td class="text-center">@item.OrderItem.LineNumber</td>
                                    <td>@item.OrderItem.Product.Code</td>
                                    <td><strong>@item.OrderItem.Product.Name</strong></td>
                                    <td class="text-end">
                                        <strong>@item.Quantity</strong>
                                    </td>
                                    <td>@item.OrderItem.Spec</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.OrderItem.DesignFileName))
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-file me-1"></i>
                                                @item.OrderItem.DesignFileName
                                            </small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <small>@(item.OrderItem.Remark ?? "-")</small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="3" class="text-end">합계:</th>
                                <th class="text-end">
                                    <strong>@Model.Card.CardItems.Sum(ci => ci.Quantity)</strong>
                                </th>
                                <th colspan="3"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- 작업 로그 -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2 text-info"></i>
                    작업 이력 (@(Model.Card.EventLogs.Count)개)
                </h5>
            </div>
            <div class="card-body">
                @if (Model.Card.EventLogs.Any())
                {
                    <div class="timeline">
                        @foreach (var log in Model.Card.EventLogs.OrderByDescending(l => l.CreatedAt))
                        {
                            <div class="timeline-item mb-3">
                                <div class="row">
                                    <div class="col-md-2 text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        @log.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")
                                    </div>
                                    <div class="col-md-2">
                                        @if (log.EventType == "작업시작")
                                        {
                                            <span class="badge bg-primary">작업시작</span>
                                        }
                                        else if (log.EventType == "작업완료")
                                        {
                                            <span class="badge bg-success">작업완료</span>
                                        }
                                        else if (log.EventType == "작업대기")
                                        {
                                            <span class="badge bg-warning text-dark">작업대기</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">@log.EventType</span>
                                        }
                                    </div>
                                    <div class="col-md-3">
                                        @if (!string.IsNullOrEmpty(log.CollectorId))
                                        {
                                            <small class="text-muted">
                                                <i class="fas fa-desktop me-1"></i>
                                                @log.CollectorId
                                            </small>
                                        }
                                    </div>
                                    <div class="col-md-5">
                                        @if (!string.IsNullOrEmpty(log.RawJson))
                                        {
                                            <details>
                                                <summary class="text-muted" style="cursor: pointer">
                                                    <small>원본 데이터 보기</small>
                                                </summary>
                                                <pre class="mt-2 p-2 bg-light border rounded" style="font-size: 0.75rem; max-height: 200px; overflow: auto;">@log.RawJson</pre>
                                            </details>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted text-center py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                        아직 작업 이력이 없습니다.
                    </p>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // 자동 새로고침 (60초마다)
        setTimeout(function() {
            location.reload();
        }, 60000);
    </script>
}
