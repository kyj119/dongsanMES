@page "{id:int}"
@model MESSystem.Pages.Cards.PrintModel
@{
    ViewData["Title"] = $"카드 인쇄 - {Model.Card?.CardNumber}";
    Layout = null;  // 인쇄용 레이아웃 - 헤더/푸터 없음
}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @@media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .print-area {
                page-break-after: auto;
            }
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            font-size: 12pt;
        }

        .print-area {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .card-header-print {
            border: 3px solid #333;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .card-number-large {
            font-size: 36pt;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #000;
            background-color: #fff;
        }

        .barcode-area {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #999;
            background-color: #fafafa;
            min-height: 100px;
        }

        .info-table {
            width: 100%;
            margin: 20px 0;
        }

        .info-table th {
            background-color: #e9ecef;
            padding: 10px;
            text-align: left;
            border: 1px solid #dee2e6;
            width: 25%;
        }

        .info-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .items-table th {
            background-color: #343a40;
            color: white;
            padding: 12px;
            text-align: center;
            border: 1px solid #000;
        }

        .items-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
        }

        .items-table tfoot td {
            background-color: #f8f9fa;
            font-weight: bold;
            padding: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            font-size: 16pt;
            font-weight: bold;
            border-radius: 5px;
            text-align: center;
        }

        .status-wait { background-color: #ffc107; color: #000; }
        .status-working { background-color: #0dcaf0; color: #000; }
        .status-complete { background-color: #198754; color: #fff; }
        .status-hold { background-color: #6c757d; color: #fff; }

        .footer-notes {
            margin-top: 30px;
            padding: 15px;
            border-top: 2px solid #000;
            font-size: 10pt;
        }
    </style>
</head>
<body>
    @if (Model.Card == null)
    {
        <div class="container mt-5">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                카드를 찾을 수 없습니다.
            </div>
        </div>
    }
    else
    {
        <!-- 인쇄 버튼 (인쇄 시 숨김) -->
        <div class="no-print text-center py-3">
            <button onclick="window.print()" class="btn btn-primary btn-lg me-2">
                <i class="fas fa-print me-2"></i> 인쇄
            </button>
            <button onclick="window.close()" class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i> 닫기
            </button>
        </div>

        <!-- 인쇄 영역 -->
        <div class="print-area">
            <!-- 헤더 -->
            <div class="card-header-print">
                <div class="row">
                    <div class="col-8">
                        <h1 style="margin: 0; font-size: 24pt;">
                            <i class="fas fa-industry me-2"></i>
                            MES 작업 카드
                        </h1>
                    </div>
                    <div class="col-4 text-end">
                        @if (Model.Card.Status == "대기")
                        {
                            <span class="status-badge status-wait">대기</span>
                        }
                        else if (Model.Card.Status == "작업중")
                        {
                            <span class="status-badge status-working">작업중</span>
                        }
                        else if (Model.Card.Status == "완료")
                        {
                            <span class="status-badge status-complete">완료</span>
                        }
                        else if (Model.Card.Status == "보류")
                        {
                            <span class="status-badge status-hold">보류</span>
                        }
                    </div>
                </div>
            </div>

            <!-- 카드번호 (크게 표시) -->
            <div class="card-number-large">
                @Model.Card.CardNumber
            </div>

            <!-- 바코드/QR 코드 영역 -->
            <div class="barcode-area">
                <div id="qrcode" class="d-inline-block"></div>
                <p class="mt-3 mb-0 text-muted">
                    <i class="fas fa-qrcode me-2"></i>
                    스캔하여 카드 정보를 확인하세요
                </p>
            </div>

            <!-- 기본 정보 -->
            <table class="info-table">
                <tr>
                    <th><i class="fas fa-tag me-2"></i>분류</th>
                    <td><strong>@Model.Card.Category.Name</strong></td>
                    <th><i class="fas fa-file-invoice me-2"></i>주문번호</th>
                    <td><strong>@Model.Card.Order.OrderNumber</strong></td>
                </tr>
                <tr>
                    <th><i class="fas fa-building me-2"></i>거래처</th>
                    <td>@Model.Card.Order.ClientName</td>
                    <th><i class="fas fa-shipping-fast me-2"></i>출고방법</th>
                    <td>@Model.Card.Order.ShippingMethod</td>
                </tr>
                <tr>
                    <th><i class="fas fa-calendar-alt me-2"></i>출고일시</th>
                    <td>
                        <strong>@Model.Card.Order.ShippingDate.ToString("yyyy-MM-dd")</strong>
                        @if (Model.Card.Order.ShippingTime.HasValue)
                        {
                            <span>(@Model.Card.Order.ShippingTime.Value.ToString(@"hh\:mm"))</span>
                        }
                    </td>
                    <th><i class="fas fa-clock me-2"></i>카드 생성일</th>
                    <td>@Model.Card.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                </tr>
            </table>

            <!-- 품목 정보 -->
            <h3 style="margin-top: 30px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                <i class="fas fa-box me-2"></i>
                품목 정보
            </h3>
            <table class="items-table">
                <thead>
                    <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 15%">품목코드</th>
                        <th style="width: 25%">품목명</th>
                        <th style="width: 10%">수량</th>
                        <th style="width: 20%">규격</th>
                        <th style="width: 25%">비고</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Card.CardItems.OrderBy(ci => ci.OrderItem.LineNumber))
                    {
                        <tr>
                            <td class="text-center">@item.OrderItem.LineNumber</td>
                            <td>@item.OrderItem.Product.Code</td>
                            <td><strong>@item.OrderItem.Product.Name</strong></td>
                            <td class="text-end"><strong>@item.Quantity</strong></td>
                            <td>@item.OrderItem.Spec</td>
                            <td>@(item.OrderItem.Remark ?? "-")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end">합계:</td>
                        <td class="text-end">
                            <strong style="font-size: 14pt;">
                                @Model.Card.CardItems.Sum(ci => ci.Quantity)
                            </strong>
                        </td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>

            <!-- 디자인 파일 정보 -->
            @{
                var filesWithDesign = Model.Card.CardItems
                    .Where(ci => !string.IsNullOrEmpty(ci.OrderItem.DesignFileName))
                    .ToList();
            }
            @if (filesWithDesign.Any())
            {
                <h4 style="margin-top: 20px;">
                    <i class="fas fa-file-image me-2"></i>
                    디자인 파일
                </h4>
                <ul style="list-style: none; padding-left: 0;">
                    @foreach (var item in filesWithDesign)
                    {
                        <li style="padding: 5px 0;">
                            <i class="fas fa-file me-2 text-primary"></i>
                            <strong>@item.OrderItem.Product.Name:</strong>
                            @item.OrderItem.DesignFileName
                        </li>
                    }
                </ul>
            }

            <!-- 푸터 -->
            <div class="footer-notes">
                <div class="row">
                    <div class="col-6">
                        <strong>작업 시작:</strong> _____________
                    </div>
                    <div class="col-6">
                        <strong>작업 완료:</strong> _____________
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <strong>작업자:</strong> _____________
                    </div>
                    <div class="col-6">
                        <strong>검수:</strong> _____________
                    </div>
                </div>
                <div class="mt-3 text-muted">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        본 카드는 MES 시스템에서 자동 생성되었습니다. 
                        (인쇄일시: @DateTime.Now.ToString("yyyy-MM-dd HH:mm"))
                    </small>
                </div>
            </div>
        </div>
    }

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        @if (Model.Card != null)
        {
            <text>
            // QR 코드 생성
            var qrcode = new QRCode(document.getElementById("qrcode"), {
                text: "@Model.Card.CardNumber",
                width: 150,
                height: 150,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            </text>
        }
    </script>
</body>
</html>
