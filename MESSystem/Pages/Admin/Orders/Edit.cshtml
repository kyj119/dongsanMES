@page
@model MESSystem.Pages.Admin.Orders.EditModel
@{
    ViewData["Title"] = $"주문서 수정 - {Model.Order.OrderNumber}";
}

<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-warning">
            <h4 class="mb-0"><i class="bi bi-pencil-square"></i> 주문서 수정 - <code>@Model.Order.OrderNumber</code></h4>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>주의:</strong> 주문서 수정 시 연결된 카드에 '수정됨' 알림이 표시됩니다.
            </div>

            <form method="post" enctype="multipart/form-data" id="orderForm">
                <input type="hidden" asp-for="Input.OrderId" />
                <input type="hidden" asp-for="Input.Version" />
                
                <!-- 거래처 정보 -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">거래처 정보</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Input.ClientName" class="form-label">
                                    거래처명 <span class="text-danger">*</span>
                                </label>
                                <input asp-for="Input.ClientName" class="form-control" />
                                <span asp-validation-for="Input.ClientName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Input.ClientPhone" class="form-label">
                                    전화번호
                                </label>
                                <input asp-for="Input.ClientPhone" class="form-control" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Input.ClientMobile" class="form-label">
                                    휴대폰
                                </label>
                                <input asp-for="Input.ClientMobile" class="form-control" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Input.ClientAddress" class="form-label">
                                    주소
                                </label>
                                <input asp-for="Input.ClientAddress" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 출고 정보 -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">출고 정보</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label asp-for="Input.ShippingMethod" class="form-label">
                                    출고방법 <span class="text-danger">*</span>
                                </label>
                                <select asp-for="Input.ShippingMethod" class="form-select" id="shippingMethod">
                                    <option value="">-- 선택 --</option>
                                    <option value="대신택배">대신택배</option>
                                    <option value="대신화물">대신화물</option>
                                    <option value="한진택배">한진택배</option>
                                    <option value="퀵">퀵</option>
                                    <option value="용차">용차</option>
                                    <option value="방문수령">방문수령</option>
                                    <option value="직접배송">직접배송</option>
                                </select>
                                <span asp-validation-for="Input.ShippingMethod" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3" id="paymentMethodGroup">
                                <label asp-for="Input.PaymentMethod" class="form-label">
                                    결제방법 <span class="text-danger" id="paymentRequired">*</span>
                                </label>
                                <select asp-for="Input.PaymentMethod" class="form-select" id="paymentMethod">
                                    <option value="">-- 선택 --</option>
                                    <option value="착불">착불</option>
                                    <option value="선불">선불</option>
                                </select>
                                <span asp-validation-for="Input.PaymentMethod" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Input.ShippingDate" class="form-label">
                                    출고일 <span class="text-danger">*</span>
                                </label>
                                <input asp-for="Input.ShippingDate" type="date" class="form-control" />
                                <span asp-validation-for="Input.ShippingDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3" id="shippingTimeGroup">
                                <label asp-for="Input.ShippingTime" class="form-label">
                                    출고시간 <span class="text-danger" id="timeRequired">*</span>
                                </label>
                                <input asp-for="Input.ShippingTime" type="time" class="form-control" />
                                <span asp-validation-for="Input.ShippingTime" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 품목 정보 -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">품목 정보</h5>
                        <button type="button" class="btn btn-sm btn-danger" id="deleteSelectedBtn" disabled>
                            <i class="bi bi-trash"></i> 선택 삭제
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-info-circle"></i>
                            <strong>수정 가능 항목:</strong> 체크박스로 품목 선택/삭제, 수량/단가/규격/비고 수정, 디자인 파일 교체 가능
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered" id="itemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" class="form-check-input" id="selectAll" title="전체 선택">
                                        </th>
                                        <th width="40">#</th>
                                        <th width="150">품목코드</th>
                                        <th width="180">품목명</th>
                                        <th width="120">규격</th>
                                        <th width="80">수량</th>
                                        <th width="100">단가</th>
                                        <th width="200">디자인파일</th>
                                        <th width="150">비고</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    @foreach (var item in Model.Order.OrderItems.OrderBy(i => i.LineNumber))
                                    {
                                        var itemIndex = item.LineNumber - 1;
                                        <tr class="item-row" data-order-item-id="@item.Id">
                                            <td class="text-center">
                                                <input type="checkbox" class="form-check-input item-checkbox">
                                            </td>
                                            <td class="text-center row-number">@item.LineNumber</td>
                                            <td>
                                                <code>@item.Product.Code</code>
                                                <input type="hidden" name="Input.Items[@itemIndex].OrderItemId" value="@item.Id" />
                                                <input type="hidden" name="Input.Items[@itemIndex].ProductId" value="@item.ProductId" class="product-id-input" />
                                            </td>
                                            <td>
                                                <strong>@item.Product.Name</strong>
                                                <br>
                                                <small class="text-muted">@item.Product.Category.Name</small>
                                            </td>
                                            <td>
                                                <input type="text" 
                                                       name="Input.Items[@itemIndex].Spec" 
                                                       class="form-control form-control-sm spec-input" 
                                                       value="@item.Spec"
                                                       placeholder="예: 1000x2000mm" />
                                            </td>
                                            <td>
                                                <input type="number" 
                                                       name="Input.Items[@itemIndex].Quantity" 
                                                       class="form-control form-control-sm" 
                                                       value="@item.Quantity"
                                                       min="1" 
                                                       required />
                                            </td>
                                            <td>
                                                <input type="number" 
                                                       name="Input.Items[@itemIndex].UnitPrice" 
                                                       class="form-control form-control-sm" 
                                                       value="@item.UnitPrice"
                                                       min="0" 
                                                       placeholder="0" />
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(item.DesignFileName))
                                                {
                                                    <div class="mb-1">
                                                        <small class="text-primary d-block">
                                                            <i class="bi bi-file-earmark"></i> @item.DesignFileName
                                                        </small>
                                                        <small class="text-muted">새 파일로 교체:</small>
                                                    </div>
                                                }
                                                <input type="file" 
                                                       name="Input.Items[@itemIndex].DesignFile" 
                                                       class="form-control form-control-sm" 
                                                       accept=".ai,.psd,.pdf,.eps,.jpg,.png" />
                                            </td>
                                            <td>
                                                <textarea name="Input.Items[@itemIndex].Remark" 
                                                          class="form-control form-control-sm" 
                                                          rows="2"
                                                          placeholder="비고">@item.Remark</textarea>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="d-flex justify-content-between">
                    <div>
                        <a asp-page="Detail" asp-route-id="@Model.Order.Id" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> 취소
                        </a>
                    </div>
                    <button type="submit" class="btn btn-warning btn-lg">
                        <i class="bi bi-save"></i> 수정 저장 (카드 알림 표시)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/order-edit.js"></script>
}
